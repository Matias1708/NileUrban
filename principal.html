<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NileUrbanLounge</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.2.0/dist/index.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.2.0/dist/index.global.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js';

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA_vfbPHFvTTg6HbsqPD4ym50Q2pfxnLYU",
            authDomain: "nileurban-c9bd9.firebaseapp.com",
            projectId: "nileurban-c9bd9",
            storageBucket: "nileurban-c9bd9.appspot.com",
            messagingSenderId: "798328145085",
            appId: "1:798328145085:web:8ad8642e133fdd6fab63d4",
            measurementId: "G-44H22X36PS"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Funci√≥n para obtener todas las reservas
        async function getRecords() {
            const reservationsCol = collection(db, 'Reserva');
            // const querySnapshot = await getDocs(reservationsCol);
            // const reservations = [];

            // querySnapshot.forEach((doc) => {
            //     const data = doc.data();
            //     reservations.push({ id: doc.id, ...data });
            // });

            const querySnapshot = await getDocs(reservationsCol);
            const reservations = [];

            querySnapshot.forEach((doc) => {
                const data = doc.data();

                // üü¢ CORRECCI√ìN: Solo a√±adir reservas si el campo 'fecha' existe üü¢
                if (data.fecha) {
                    reservations.push({ id: doc.id, ...data });
                } else {
                    // Esto ayudar√° a identificar registros mal formados en la consola
                    console.error('Registro de reserva corrupto encontrado y omitido (sin fecha). ID:', doc.id);
                }
            });

            // Agrupar reservas por fecha
            const groupedReservations = reservations.reduce((acc, reservation) => {
                if (!acc[reservation.fecha]) {
                    acc[reservation.fecha] = [];
                }
                acc[reservation.fecha].push(reservation);
                return acc;
            }, {});

            // Ordenar las fechas
            const sortedDates = Object.keys(groupedReservations).sort((a, b) => parseDate(a) - parseDate(b));

            // Funci√≥n para obtener el nombre del d√≠a de la semana
            // function getDayName(dateString) {
            //     const [day, month] = dateString.split('/');
            //     const date = new Date(2025, month - 1, day); // Usa el a√±o actual o uno fijo
            //     const options = { weekday: 'long' };
            //     return new Intl.DateTimeFormat('es-ES', options).format(date);
            // }

            // Funci√≥n para obtener el nombre del d√≠a de la semana
            function getDayName(dateString) {
                // Asegurarse de obtener D√≠a, Mes Y A√±o
                const [day, month, year] = dateString.split('/');

                // Si no se proporcion√≥ el a√±o, usa el actual (o uno fijo si es necesario)
                const fullYear = year ? parseInt(year, 10) : new Date().getFullYear();

                // Crear la fecha usando las 3 partes
                // Nota: El mes es base 0 en JavaScript (enero=0)
                const date = new Date(fullYear, month - 1, day);

                // Verificar si la fecha es v√°lida antes de formatear
                if (isNaN(date.getTime())) {
                    // En caso de error, devolver un texto de error o un valor seguro
                    console.error("Fecha inv√°lida en getDayName:", dateString);
                    return "Fecha Inv√°lida";
                }

                const options = { weekday: 'long' };
                return new Intl.DateTimeFormat('es-ES', options).format(date);
            }

            // Funci√≥n para verificar si una fecha es pasada
            function isPastDate(dateString) {
                const [day, month, year] = dateString.split('/');
                const date = new Date(year, month - 1, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Resetear horas para comparar solo fechas
                return date < today;
            }

            function isPastHour(reservationHour) {
                const now = new Date();
                const [reservationHourInt, reservationMinute] = reservationHour.split(':').map(Number);
                const reservationTime = new Date();
                reservationTime.setHours(reservationHourInt, reservationMinute);

                return reservationTime < now;
            }

            // Funci√≥n para ordenar las reservas por hora
            function sortReservationsByTime(reservations) {
                return reservations.sort((a, b) => {
                    // Suponiendo que la hora est√° en formato "HH:mm"
                    const [aHour, aMinute] = a.hora.split(':').map(Number);
                    const [bHour, bMinute] = b.hora.split(':').map(Number);
                    return aHour - bHour || aMinute - bMinute;
                });
            }

            // Funci√≥n para agrupar reservas por barbero
            function groupReservationsByBarber(reservations) {
                return reservations.reduce((acc, reservation) => {
                    if (!acc[reservation.profesional]) {
                        acc[reservation.profesional] = [];
                    }
                    acc[reservation.profesional].push(reservation);
                    return acc;
                }, {});
            }

            const appointmentList = document.getElementById('appointment-list');
            appointmentList.innerHTML = ''; // Limpiar la lista antes de agregar los nuevos elementos

            // Crear contenedor principal para las columnas de barberos
            const barberContainer = document.createElement('div');
            barberContainer.className = 'barber-columns-container';
            barberContainer.innerHTML = `
                <div class="view-controls">
                    <button id="column-view-btn" class="view-btn active">Vista por Columnas</button>
                    <button id="filter-view-btn" class="view-btn">Vista con Filtro</button>
                    <a href="finance.html" class="view-btn" style="text-decoration: none;">Ir a Finanzas</a>
                </div>
                <div id="column-view" class="view-content">
                    <div class="barber-columns" id="barber-columns"></div>
                </div>
                <div id="filter-view" class="view-content" style="display: none;">
                    <div class="filter-controls">
                        <label for="barber-filter" style="color: white; margin-right: 10px;">Filtrar por barbero:</label>
                        <select id="barber-filter">
                            <option value="">Todos los barberos</option>
                            <option value="Pablo">Pablo</option>
                            <option value="Lautaro">Lautaro</option>
                            <option value="Nicolas">Nicolas</option>
                            <option value="Matias">Matias</option>
                        </select>
                    </div>
                    <div id="filtered-appointments"></div>
                </div>
            `;
            appointmentList.appendChild(barberContainer);

            // Funci√≥n para renderizar vista por columnas
            function renderColumnView() {
                const barberColumns = document.getElementById('barber-columns');
                barberColumns.innerHTML = '';

                // Obtener todos los barberos √∫nicos
                const allBarbers = [...new Set(reservations.map(r => r.profesional))];

                // Si no hay barberos, mostrar mensaje
                if (allBarbers.length === 0) {
                    barberColumns.innerHTML = '<p style="text-align: center; color: #ccc;">No hay turnos reservados</p>';
                    return;
                }

                allBarbers.forEach(barber => {
                    const barberColumn = document.createElement('div');
                    barberColumn.className = 'barber-column';
                    barberColumn.innerHTML = `<h3>${barber}</h3>`;

                    // Filtrar reservas por barbero
                    const barberReservations = reservations.filter(r => r.profesional === barber);

                    // Si no hay reservas para este barbero, mostrar mensaje
                    if (barberReservations.length === 0) {
                        const noReservationsMsg = document.createElement('p');
                        noReservationsMsg.textContent = 'Sin turnos';
                        noReservationsMsg.style.color = '#888';
                        noReservationsMsg.style.textAlign = 'center';
                        noReservationsMsg.style.fontStyle = 'italic';
                        barberColumn.appendChild(noReservationsMsg);
                    } else {
                        // Agrupar por fecha
                        const barberGroupedByDate = barberReservations.reduce((acc, reservation) => {
                            if (!acc[reservation.fecha]) {
                                acc[reservation.fecha] = [];
                            }
                            acc[reservation.fecha].push(reservation);
                            return acc;
                        }, {});

                        // Ordenar fechas para este barbero y filtrar fechas pasadas
                        const barberSortedDates = Object.keys(barberGroupedByDate)
                            .filter(date => !isPastDate(date))
                            .sort((a, b) => parseDate(a) - parseDate(b));

                        barberSortedDates.forEach(date => {
                            const dayName = getDayName(date);
                            const dateHeader = document.createElement('h4');
                            dateHeader.textContent = `${dayName} ${date}`;
                            barberColumn.appendChild(dateHeader);

                            const list = document.createElement('ul');
                            const sortedReservations = sortReservationsByTime(barberGroupedByDate[date]);

                            sortedReservations.forEach(reservation => {
                                const listItem = document.createElement('li');
                                listItem.innerHTML =
                                    `<input type="checkbox" class="whatsapp-checkbox" data-id="${reservation.id}" ${reservation.enviar === 'S' ? 'checked' : ''}>
                                <span class="appointment-details">
                                    ${reservation.nombre} - ${reservation.hora}hs - ${reservation.servicio} - 
                                    <a href="https://wa.me/${reservation.contacto}?text=${encodeURIComponent(`¬°Hola ${reservation.nombre}! Te recordamos tu turno el dia ${reservation.fecha} a las ${reservation.hora} con ${reservation.profesional} para ${reservation.servicio}. En caso de no asistir, avisar por este medio. ¬°Te esperamos!`)}" target="_blank">
                                        ${reservation.contacto}
                                    </a>
                                </span>
                                <button class="delete-btn" data-id="${reservation.id}"><i class="fas fa-trash"></i></button>`;

                                list.appendChild(listItem);

                                // Agregar evento para actualizar Firestore cuando cambie el checkbox
                                const checkbox = listItem.querySelector('.whatsapp-checkbox');
                                checkbox.addEventListener('change', async (event) => {
                                    const isChecked = event.target.checked;
                                    const reservationId = event.target.getAttribute('data-id');

                                    // Llamar a la funci√≥n para actualizar Firestore
                                    await updateSendStatus(reservationId, isChecked);
                                });
                            });

                            barberColumn.appendChild(list);
                        });
                    }

                    barberColumns.appendChild(barberColumn);
                });
            }

            // Funci√≥n para renderizar vista con filtro
            function renderFilterView() {
                const filteredAppointments = document.getElementById('filtered-appointments');
                filteredAppointments.innerHTML = '';

                // Filtrar fechas pasadas
                const futureDates = sortedDates.filter(date => !isPastDate(date));

                futureDates.forEach(date => {
                    const dayName = getDayName(date);
                    const dateHeader = document.createElement('h3');
                    dateHeader.textContent = `${dayName} ${date}`;
                    dateHeader.className = `date-header date-${date}`;
                    filteredAppointments.appendChild(dateHeader);

                    const list = document.createElement('ul');
                    const sortedReservations = sortReservationsByTime(groupedReservations[date]);

                    sortedReservations.forEach(reservation => {
                        const listItem = document.createElement('li');
                        listItem.className = `appointment-item barber-${reservation.profesional.toLowerCase()} date-${reservation.fecha}`;
                        listItem.innerHTML =
                            `<input type="checkbox" class="whatsapp-checkbox" data-id="${reservation.id}" ${reservation.enviar === 'S' ? 'checked' : ''}>
                        <span class="appointment-details">
                            <strong>${reservation.profesional}:</strong> ${reservation.nombre} - ${reservation.hora}hs - ${reservation.servicio} - 
                            <a href="https://wa.me/${reservation.contacto}?text=${encodeURIComponent(`¬°Hola ${reservation.nombre}! Te recordamos tu turno el dia ${reservation.fecha} a las ${reservation.hora} con ${reservation.profesional} para ${reservation.servicio}. En caso de no asistir, avisar por este medio. ¬°Te esperamos!`)}" target="_blank">
                                ${reservation.contacto}
                            </a>
                        </span>
                        <button class="delete-btn" data-id="${reservation.id}"><i class="fas fa-trash"></i></button>`;

                        list.appendChild(listItem);

                        // Agregar evento para actualizar Firestore cuando cambie el checkbox
                        const checkbox = listItem.querySelector('.whatsapp-checkbox');
                        checkbox.addEventListener('change', async (event) => {
                            const isChecked = event.target.checked;
                            const reservationId = event.target.getAttribute('data-id');

                            // Llamar a la funci√≥n para actualizar Firestore
                            await updateSendStatus(reservationId, isChecked);
                        });
                    });

                    filteredAppointments.appendChild(list);
                });
            }

            // Renderizar vista inicial (columnas)
            renderColumnView();

            // Event listeners para cambiar entre vistas
            document.getElementById('column-view-btn').addEventListener('click', function () {
                document.getElementById('column-view').style.display = 'block';
                document.getElementById('filter-view').style.display = 'none';
                this.classList.add('active');
                document.getElementById('filter-view-btn').classList.remove('active');
            });

            document.getElementById('filter-view-btn').addEventListener('click', function () {
                document.getElementById('column-view').style.display = 'none';
                document.getElementById('filter-view').style.display = 'block';
                this.classList.add('active');
                document.getElementById('column-view-btn').classList.remove('active');
                renderFilterView();
            });

            // Event listener para el filtro de barbero
            document.getElementById('barber-filter').addEventListener('change', function () {
                const selectedBarber = this.value;
                const appointmentItems = document.querySelectorAll('.appointment-item');

                appointmentItems.forEach(item => {
                    if (selectedBarber === '' || item.classList.contains(`barber-${selectedBarber.toLowerCase()}`)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // Funci√≥n as√≠ncrona para actualizar el estado de 'enviar' en Firestore
            async function updateSendStatus(reservationId, isChecked) {
                try {
                    // Obtener la referencia al documento
                    const reservationRef = doc(db, 'Reserva', reservationId);

                    // Actualizar el campo 'enviar' en Firestore
                    await updateDoc(reservationRef, {
                        enviar: isChecked ? 'S' : 'N'
                    });

                    console.log('Estado de env√≠o actualizado en Firestore');
                } catch (error) {
                    console.error('Error al actualizar el estado de env√≠o:', error);
                }
            }


            // Agregar evento para eliminar turnos
            // Delegaci√≥n de eventos para eliminar turnos (funciona para vistas din√°micas columnas/filtro)
            appointmentList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;

                    if (confirm('¬øEst√°s seguro de que deseas eliminar este turno?')) {
                        try {
                            await deleteDoc(doc(db, 'Reserva', id));
                            alert('Turno eliminado con √©xito');
                            getRecords(); // Recargar la lista
                        } catch (error) {
                            console.error('Error al eliminar el turno: ', error);
                            alert('Error al eliminar: ' + error.message);
                        }
                    }
                }
            });
        }

        // Funci√≥n para obtener las reservas para una fecha y profesional espec√≠ficos
        async function getReservationsForDateAndProfessional(date, professional) {
            const querySnapshot = await getDocs(query(
                collection(db, 'Reserva'),
                where('fecha', '==', date),
                where('profesional', '==', professional)
            ));
            const reservations = [];
            querySnapshot.forEach((doc) => {
                reservations.push(doc.data());
            });
            return reservations;
        }
        let isBooking = false;

        async function bookAppointment() {
            if (isBooking) return;

            const name = document.getElementById('name').value;
            const date = document.getElementById('calendar').value;
            const time = document.getElementById('time').value;
            const professional = document.getElementById('professional').value;
            const service = document.getElementById('service').value;
            const phone = document.getElementById('phone').value;

            if (name && date && time && professional && service && phone) {
                // Validar que la fecha no sea posterior a una semana desde hoy
                const today = new Date();
                const maxDate = new Date(today);
                maxDate.setDate(today.getDate() + 90);




                const [day, month, year] = date.split('/');
                const selectedDate = new Date(year, month - 1, day);



                if (selectedDate > maxDate) {
                    alert('Actualmente no estamos aceptando reservas para despu√©s de la semana pr√≥xima debido a actualizaciones en nuestro sistema. Por favor, intenta nuevamente m√°s tarde.');
                    return;
                }

                // POR ESTA (convertir a d√≠a laboral):
                // if (professional === 'Matias') {
                //     const dayOfWeek = selectedDate.getDay();
                //     // Convertir: Martes=2‚Üí1, Mi√©rcoles=3‚Üí2, Jueves=4‚Üí3, Viernes=5‚Üí4, S√°bado=6‚Üí5
                //     const diaLaboral = dayOfWeek >= 2 ? dayOfWeek - 1 : null;
                //     if (diaLaboral !== 3 && diaLaboral !== 4 && diaLaboral !== 5) {
                //     alert('Matias solo ofrece turnos los jueves, viernes y s√°bados.');
                //     return;
                // }
                // }
                // Validaci√≥n de disponibilidad de Mat√≠as, con excepci√≥n para Lunes 22 y 29
                // if (professional === 'Matias') {

                //     // üü¢ EXCEPCI√ìN PARA LUNES ESPECIALES üü¢
                //     // La variable 'date' (DD/MM/YYYY) est√° disponible en la funci√≥n.
                //     if (date === '22/12/2025' || date === '29/12/2025') {
                //         console.log('Matias: Lunes especial habilitado para reserva.');
                //         // Si es un lunes especial, la funci√≥n contin√∫a sin mostrar la alerta.
                //     } else {
                //         // Validaci√≥n normal de d√≠as (Jueves, Viernes, S√°bado)
                //         const dayOfWeek = selectedDate.getDay();
                //         // Convertir: Martes=2‚Üí1, Mi√©rcoles=3‚Üí2, Jueves=4‚Üí3, Viernes=5‚Üí4, S√°bado=6‚Üí5
                //         const diaLaboral = dayOfWeek >= 2 ? dayOfWeek - 1 : null;

                //         if (diaLaboral !== 3 && diaLaboral !== 4 && diaLaboral !== 5) {
                //             alert('Matias solo ofrece turnos los jueves, viernes y s√°bados.');
                //             return;
                //         }
                //     }
                // }

                if (professional === 'Matias') {

                    // üü¢ EXCEPCI√ìN PARA D√çAS ESPECIALES üü¢
                    // La variable 'date' (DD/MM/YYYY) est√° disponible en la funci√≥n.
                    const specialDates = [
                        '22/12/2025',
                        '23/12/2025', // üëà ¬°Nuevo! Martes 23
                        '24/12/2025', // üëà ¬°Nuevo! Mi√©rcoles 24
                        '29/12/2025',
                        '30/12/2025', // üëà ¬°Nuevo! Martes 30
                        '31/12/2025'  // üëà ¬°Nuevo! Mi√©rcoles 31
                    ];

                    if (specialDates.includes(date)) {
                        console.log('Matias: D√≠a especial habilitado para reserva.');
                        // Si es un d√≠a especial, la funci√≥n contin√∫a sin mostrar la alerta.
                    } else {
                        // Validaci√≥n normal de d√≠as (Jueves, Viernes, S√°bado)
                        const dayOfWeek = selectedDate.getDay();
                        // Convertir: Martes=2‚Üí1, Mi√©rcoles=3‚Üí2, Jueves=4‚Üí3, Viernes=5‚Üí4, S√°bado=6‚Üí5
                        const diaLaboral = dayOfWeek >= 2 ? dayOfWeek - 1 : null;

                        if (diaLaboral !== 3 && diaLaboral !== 4 && diaLaboral !== 5) {
                            alert('Matias solo ofrece turnos los jueves, viernes y s√°bados.');
                            return;
                        }
                    }
                }
                // Resto del c√≥digo de validaci√≥n y reserva...
                const bookBtn = document.getElementById('book-button');
                const setBookingState = (active) => {
                    isBooking = active;
                    if (bookBtn) {
                        bookBtn.disabled = active;
                        bookBtn.textContent = active ? 'Reservando...' : 'RESERVAR';
                    }
                };

                setBookingState(true);

                try {
                    // Verificar si la hora est√° disponible
                    const reservations = await getReservationsForDateAndProfessional(date, professional);
                    const reservedTimes = reservations.map(reservation => reservation.hora);

                    if (reservedTimes.includes(time)) {
                        alert('La hora seleccionada ya est√° reservada. Por favor, elige otra hora.');
                        return;
                    }

                    // Guardar la reserva en Firebase
                    await addDoc(collection(db, 'Reserva'), {
                        nombre: name,
                        fecha: date,
                        hora: time,
                        profesional: professional,
                        servicio: service,
                        contacto: phone,
                        enviar: 'N'
                    });
                    alert(`Se realiz√≥ la reserva para el dia ${date} a las ${time}hs con ${professional}, para realizarse el servicio de ${service}. No te olvides, te esperamos!`);
                    await getRecords();
                    showConfirmationModal();
                } catch (error) {
                    console.error('Error al a√±adir la reserva: ', error);
                } finally {
                    setBookingState(false);
                }
            } else {
                alert('Por favor, completa todos los campos.');
            }
        }
        // === FUNCI√ìN populateTimeOptions() CORREGIDA Y COMPLETA ===
        async function populateTimeOptions() {
            const timeSelect = document.getElementById('time');
            const noAvailableMessage = document.getElementById('no-available-message');
            const date = document.getElementById('calendar').value;
            const professional = document.getElementById('professional').value;

            console.log('--- populateTimeOptions INICIADA ---');
            console.log('Fecha seleccionada:', date);
            console.log('Profesional seleccionado:', professional);


            if (!date || !professional) {
                console.log('Fecha o profesional no seleccionados. Limpiando selector de hora.');
                timeSelect.innerHTML = '<option value="">Seleccione fecha y profesional</option>'; // Reset message
                noAvailableMessage.textContent = 'No hay turnos disponibles para la fecha seleccionada.';
                noAvailableMessage.style.display = 'none';
                console.log('--- populateTimeOptions FINALIZADA (sin fecha/profesional) ---');
                return;
            }

            // Lista base de horarios disponibles
            const baseAvailableTimes = [
                '10:15',
                '11:00',
                '11:45',
                '12:30',
                '13:30',
                '14:15',
                '15:00',
                '15:45',
                '16:30',
                '17:15',
                '18:00',
                '18:45'
            ];
            console.log('Lista base de horarios:', baseAvailableTimes);


            // Define horarios espec√≠ficos excluidos por profesional y d√≠a
            const professionalSpecificExclusions = {
                'Nicolas': {
                    1: ['10:15', '11:00'],
                    2: ['18:00', '18:45'],
                    3: ['17:15', '18:00'],
                    4: ['10:15', '14:15', '17:15']
                },
                'Lautaro': {
                    3: ['15:45'],
                    5: ['17:15']
                },
                'Pablo': {
                    5: ['18:45']
                }
            };


            // Obtener y formatear la fecha
            const [day, month, year] = date.split('/');
            const formattedDate = `${year}-${month}-${day}`;
            const dateObj = new Date(formattedDate);
            const dayOfWeek = dateObj.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S√°bado

            // // Restricci√≥n de Mat√≠as (solo Jueves, Viernes, S√°bado)
            // if (professional === 'Matias' && dayOfWeek !== 3 && dayOfWeek !== 4 && dayOfWeek !== 5) { 
            //     // Permite excepciones especiales de lunes antes de este return
            //     if (date !== '22/12/2025' && date !== '29/12/2025') {
            //         timeSelect.innerHTML = '';
            //         const defaultOption = document.createElement('option');
            //         defaultOption.value = '';
            //         defaultOption.disabled = true;
            //         defaultOption.selected = true;
            //         timeSelect.appendChild(defaultOption);
            //         noAvailableMessage.style.display = 'block';
            //         console.log('--- populateTimeOptions FINALIZADA (d√≠a inv√°lido para Matias) ---');
            //         return;
            //     }
            // }

            if (professional === 'Matias' && dayOfWeek !== 3 && dayOfWeek !== 4 && dayOfWeek !== 5) {
                // Permite excepciones especiales de d√≠as antes de este return

                // Lista de todas las excepciones especiales
                const specialDates = [
                    '22/12/2025',
                    '23/12/2025', // üëà ¬°Nuevo!
                    '24/12/2025', // üëà ¬°Nuevo!
                    '29/12/2025',
                    '30/12/2025', // üëà ¬°Nuevo!
                    '31/12/2025'  // üëà ¬°Nuevo!
                ];

                // Si la fecha actual NO est√° incluida en las fechas especiales, entonces bloqueamos.
                if (!specialDates.includes(date)) {
                    timeSelect.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    defaultOption.textContent = 'Selecciona un horario'; // A√±adido para mejor UX
                    timeSelect.appendChild(defaultOption);
                    noAvailableMessage.style.display = 'block';
                    console.log('--- populateTimeOptions FINALIZADA (d√≠a inv√°lido para Matias) ---');
                    return;
                }

                // Si la fecha S√ç est√° en specialDates, el c√≥digo contin√∫a y se cargan los horarios.
            }
            noAvailableMessage.textContent = 'No hay turnos disponibles para la fecha seleccionada.';


            // Obtener la hora actual
            const now = new Date();
            const currentDateFormatted = `${now.getFullYear()}-${("0" + (now.getMonth() + 1)).slice(-2)}-${("0" + now.getDate()).slice(-2)}`;

            // Obt√©n las reservas
            const reservations = await getReservationsForDateAndProfessional(date, professional);
            const reservedTimesForDateAndProfessional = reservations.map(reservation => reservation.hora);


            timeSelect.innerHTML = ''; // Limpiar las opciones actuales
            let hasAvailableTimes = false;

            // Determinar la lista de horarios a iterar: base o una versi√≥n filtrada por horario de inicio
            let timesToIterate = [...baseAvailableTimes];


            // üü¢ REGLA TEMPORAL: Lunes 22/12/2025 y Lunes 29/12/2025 üü¢
            if (date === '22/12/2025' || date === '29/12/2025') {
                console.log(`Regla temporal aplicada para el ${date}.`);
                const mondayTimes = [
                    '10:15', '11:00', '11:45', '12:30',
                    '13:30', '14:15', '15:00', '15:45',
                    '16:30', '17:15', '18:00', '18:45',
                    '19:30' // El √∫ltimo turno
                ];
                timesToIterate = mondayTimes;
            }
            // üî¥ FIN REGLA TEMPORAL üî¥


            // === L√≥gica de Horario de Inicio por Profesional y D√≠a ===
            // üí° NOTA: El Lunes es el d√≠a de la semana '1' en JavaScript.

            if (professional === 'Matias' && (dayOfWeek === 3)) {
                // Horario normal de Matias (Jueves), comienza 12:30
                timesToIterate = timesToIterate.filter(time => time >= '12:30');

            } else if (professional === 'Matias' && dayOfWeek === 1) {
                // üü¢ NUEVO: Mat√≠as en Lunes 22/12 y 29/12
                // No se aplica ning√∫n filtro de inicio aqu√≠. El horario de 10:15 a 19:30
                // ya est√° cargado en 'timesToIterate' por la regla temporal anterior.
                console.log("Matias: Usando horario especial de Lunes (10:15 - 19:30).");

            } else if (professional === 'Nicolas' && dayOfWeek === 2) {
                timesToIterate = timesToIterate.filter(time => time >= '14:15');

            } else if (professional === 'Lautaro' && dayOfWeek === 1) {
                timesToIterate = timesToIterate.filter(time => time >= '12:30');

            } else if (professional === 'Lautaro' && dayOfWeek === 3) {
                timesToIterate = timesToIterate.filter(time => time >= '12:30');
            }
            // // === L√≥gica de Horario de Inicio por Profesional y D√≠a ===
            // if (professional === 'Matias' && dayOfWeek === 3) { 
            //     timesToIterate = timesToIterate.filter(time => time >= '12:30');
            // } else if (professional === 'Nicolas' && dayOfWeek === 2) { 
            //     timesToIterate = timesToIterate.filter(time => time >= '14:15');
            // } else if (professional === 'Lautaro' && dayOfWeek === 1) { 
            //     timesToIterate = timesToIterate.filter(time => time >= '13:30');
            // } else if (professional === 'Lautaro' && dayOfWeek === 3) { 
            //     timesToIterate = timesToIterate.filter(time => time >= '12:30');
            // }


            // Aqu√≠ se agrega el nuevo horario solo para viernes y s√°bado (y se asegura que no se duplique si ya est√° por la regla temporal)
            if (dayOfWeek === 5 || dayOfWeek === 4) {
                if (!timesToIterate.includes('19:30')) {
                    timesToIterate.push('19:30');
                    timesToIterate.sort();
                }
            }
            const currentExclusions = professionalSpecificExclusions[professional]?.[dayOfWeek] || [];


            // Iterar sobre la lista de horarios determinada
            timesToIterate.forEach(optionValue => {
                const optionText = `${optionValue} hs`;

                // Convertir la hora del turno a un objeto Date
                const optionDateTime = new Date(`${formattedDate}T${optionValue}:00`);

                // Comprobar si es para el pasado
                const isPast = formattedDate === currentDateFormatted &&
                    (now.getHours() > optionDateTime.getHours() ||
                        (now.getHours() === optionDateTime.getHours() && now.getMinutes() >= optionDateTime.getMinutes()));

                // Comprobar si es una hora excluida espec√≠ficamente
                const isSpecificallyExcluded = currentExclusions.includes(optionValue);

                // Comprobar si ya est√° reservada
                const isReserved = reservedTimesForDateAndProfessional.includes(optionValue);


                // Si no es en el pasado, no est√° excluida y no est√° reservada, agregar la opci√≥n
                if (!isPast && !isSpecificallyExcluded && !isReserved) {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;
                    timeSelect.appendChild(option);
                    hasAvailableTimes = true;
                }
            });

            // Si no se agregaron opciones, a√±ade el mensaje de no disponibles
            if (!hasAvailableTimes) {
                timeSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "No hay turnos disponibles";
                defaultOption.disabled = true;
                timeSelect.appendChild(defaultOption);
                noAvailableMessage.style.display = 'block';
            } else {
                noAvailableMessage.style.display = 'none';
            }


            console.log('--- populateTimeOptions FINALIZADA ---');
        }
        // === FIN FUNCI√ìN populateTimeOptions() CORREGIDA Y COMPLETA ===
        // === START MODIFIED populateTimeOptions Function (with updated rules and console.log for debugging) ===
        //         async function populateTimeOptions() {
        //             const timeSelect = document.getElementById('time');
        //             const noAvailableMessage = document.getElementById('no-available-message');
        //             const date = document.getElementById('calendar').value;
        //             const professional = document.getElementById('professional').value;

        //             console.log('--- populateTimeOptions INICIADA ---');
        //             console.log('Fecha seleccionada:', date);
        //             console.log('Profesional seleccionado:', professional);


        //             if (!date || !professional) {
        //                 console.log('Fecha o profesional no seleccionados. Limpiando selector de hora.');
        //                 timeSelect.innerHTML = '<option value="">Seleccione fecha y profesional</option>'; // Reset message
        //                 noAvailableMessage.textContent = 'No hay turnos disponibles para la fecha seleccionada.';
        //                 noAvailableMessage.style.display = 'none';
        //                 console.log('--- populateTimeOptions FINALIZADA (sin fecha/profesional) ---');
        //                 return;
        //             }

        //             // Lista base de horarios disponibles (basada en tu √∫ltima lista proporcionada)
        //             const baseAvailableTimes = [
        //                 '10:15',
        //                 '11:00',
        //                 '11:45',
        //                 '12:30',
        //                 '13:30',
        //                 '14:15',
        //                 '15:00',
        //                 '15:45',
        //                 '16:30',
        //                 '17:15',
        //                 '18:00',
        //                 '18:45'
        //             ];
        //              console.log('Lista base de horarios:', baseAvailableTimes);


        //             // Define horarios espec√≠ficos excluidos por profesional y d√≠a
        //             // Las claves num√©ricas son los d√≠as de la semana (1=Martes, 2=Mi√©rcoles, 3=Jueves, 4=Viernes, 6=S√°bado)
        //             // Estas son exclusiones de turnos *fijos* que no est√°n disponibles, *adem√°s* de los filtros por horario de inicio
        //             const professionalSpecificExclusions = {
        //                 'Nicolas': {
        //                     1: ['10:15','11:00'], // Martes (2): 12:30 excluido
        //                     2: ['18:00','18:45'],
        //                     3: ['17:15','18:00'], // Jueves (4): 17:15 y 18:00 excluidos
        //                     4: ['10:15', '14:15','17:15'] // Viernes (5): 10:15 y 14:15 excluidos
        //                 },
        //                 'Lautaro': {
        //                     3: ['15:45'],
        //                     5: ['17:15']// Jueves (4): 13:30 excluido
        //                     // A√±adir otras exclusiones fijas si las hay para otros d√≠as o horarios
        //                 },
        //                  'Pablo': {
        //                     5: ['18:45']// Define aqu√≠ las exclusiones fijas de Pablo si las hay
        //                  }
        //                 // A√±adir otros profesionales si tienes m√°s
        //             };


        //             // Convertir la fecha del formato DD/MM/YYYY al formatoYYYY-MM-DD para crear objetos Date
        //             const [day, month, year] = date.split('/');
        //             const formattedDate = `${year}-${month}-${day}`;
        //             const dateObj = new Date(formattedDate);

        //             // Determinar el d√≠a de la semana (0 = Domingo, 1 = Lunes, ..., 6 = S√°bado)
        //             const dayOfWeek = dateObj.getDay();
        //             console.log('D√≠a de la semana (0=Dom, 1=Lun, etc.):', dayOfWeek);

        //             if (professional === 'Matias' && dayOfWeek !== 3 && dayOfWeek !== 4 && dayOfWeek !== 5) { 
        //                 //console.log('Matias solo atiende viernes y s√°bados. Fecha seleccionada inv√°lida.');
        //                 timeSelect.innerHTML = '';
        //                 const defaultOption = document.createElement('option');
        //                 defaultOption.value = '';
        //                 //defaultOption.textContent = 'Seleccione un viernes o s√°bado';
        //                 defaultOption.disabled = true;
        //                 defaultOption.selected = true;
        //                 timeSelect.appendChild(defaultOption);
        //                 //noAvailableMessage.textContent = 'Matias solo atiende viernes y s√°bados.';
        //                 noAvailableMessage.style.display = 'block';
        //                 console.log('--- populateTimeOptions FINALIZADA (d√≠a inv√°lido para Matias) ---');
        //                 return;
        //             }
        //             noAvailableMessage.textContent = 'No hay turnos disponibles para la fecha seleccionada.';


        //             // Obtener la hora actual
        //             const now = new Date();
        //             const currentDateFormatted = `${now.getFullYear()}-${("0" + (now.getMonth() + 1)).slice(-2)}-${("0" + now.getDate()).slice(-2)}`;

        //             console.log('Fecha actual formateada:', currentDateFormatted);
        //             console.log('Hora actual:', now.getHours() + ':' + ("0" + now.getMinutes()).slice(-2));


        //             // Obt√©n las reservas para la fecha y profesional seleccionados
        //             const reservations = await getReservationsForDateAndProfessional(date, professional);
        //             const reservedTimesForDateAndProfessional = reservations.map(reservation => reservation.hora);
        //             console.log('Horarios ya reservados para esta fecha y profesional:', reservedTimesForDateAndProfessional);


        //             timeSelect.innerHTML = ''; // Limpiar las opciones actuales

        //             let hasAvailableTimes = false;

        //             // Determinar la lista de horarios a iterar: base o una versi√≥n filtrada por horario de inicio
        //              let timesToIterate = [...baseAvailableTimes]; // Copia la base para no modificarla

        //             // üü¢ NUEVO C√ìDIGO A√ëADIDO AQU√ç üü¢
        //     // REGLA TEMPORAL: Agregar turnos para Lunes 22/12/2025 y Lunes 29/12/2025
        //     if (date === '22/12/2025' || date === '29/12/2025') {
        //         console.log(`Regla temporal aplicada para el ${date}.`);
        //         // Define los horarios espec√≠ficos de 10:15 a 19:30
        //         const mondayTimes = [
        //             '10:15', '11:00', '11:45', '12:30',
        //             '13:30', '14:15', '15:00', '15:45',
        //             '16:30', '17:15', '18:00', '18:45', 
        //             '19:30' // El √∫ltimo turno
        //         ];
        //         // Sobrescribir la lista base para incluir solo estos horarios de lunes
        //         timesToIterate = mondayTimes; 
        //     }
        //     // üî¥ FIN DEL NUEVO C√ìDIGO üî¥
        //              // === L√≥gica de Horario de Inicio por Profesional y D√≠a ===
        //              // Filtra la lista base de horarios para que empiece desde el horario correcto
        //             //  if (professional === 'Nicolas' && dayOfWeek === 2) { // Nicolas los Mi√©rcoles (3) empieza a las 14:15
        //             //      console.log('Nicolas: aplicando filtro de inicio (>= 14:15) para Mi√©rcoles.');
        //             //      timesToIterate = timesToIterate.filter(time => time >= '14:15');
        //             //  } else if (professional === 'Lautaro' && (dayOfWeek === 1 || dayOfWeek === 3)) { // Lautaro los Martes (2) y Jueves (4) empieza a las 13:30
        //             //      console.log('Lautaro: aplicando filtro de inicio (>= 13:30) para Martes/Jueves.');
        //             //      timesToIterate = timesToIterate.filter(time => time >= '13:30');
        //             //  }

        //             if (professional === 'Matias' && dayOfWeek === 3) { // Matias los Jueves (4) empieza a las 12:30
        //     console.log('Matias: aplicando filtro de inicio (>= 12:30) para Jueves.');
        //     timesToIterate = timesToIterate.filter(time => time >= '12:30');
        // } else if (professional === 'Nicolas' && dayOfWeek === 2) { // Nicolas los Mi√©rcoles (3) empieza a las 14:15
        //     console.log('Nicolas: aplicando filtro de inicio (>= 14:15) para Mi√©rcoles.');
        //     timesToIterate = timesToIterate.filter(time => time >= '14:15');
        // } else if (professional === 'Lautaro' && dayOfWeek === 1) { // Lautaro los Martes (2) empieza a las 13:30
        //     console.log('Lautaro: aplicando filtro de inicio (>= 13:30) para Martes.');
        //     timesToIterate = timesToIterate.filter(time => time >= '13:30');
        // } else if (professional === 'Lautaro' && dayOfWeek === 3) { // Lautaro los Jueves (4) empieza a las 12:30
        //     console.log('Lautaro: aplicando filtro de inicio (>= 12:30) para Jueves.');
        //     timesToIterate = timesToIterate.filter(time => time >= '12:30');
        // }
        //              // A√±adir l√≥gica similar para otros profesionales si tienen horarios de inicio diferentes en d√≠as espec√≠ficos
        //              // Por ejemplo, si Pablo empieza a las 11:00 los Jueves/Viernes:
        //              // else if (professional === 'Pablo' && (dayOfWeek === 4 || dayOfWeek === 5)) {
        //              //    console.log('Pablo: aplicando filtro de inicio (>= 11:00) para Jueves/Viernes.');
        //              //    timesToIterate = timesToIterate.filter(time => time >= '11:00');
        //              // }
        //              // Si un profesional no tiene un filtro espec√≠fico para un d√≠a, timesToIterate sigue siendo la lista base o la lista filtrada por reglas anteriores.


        //             // Obtener las exclusiones espec√≠ficas para el profesional seleccionado y el d√≠a de la semana
        //             // Usa el operador ?. para evitar errores si el profesional o el d√≠a no tienen exclusiones definidas

        //             ¬†// Aqu√≠ se agrega el nuevo horario solo para viernes y s√°bado
        //             ¬† ¬† ¬† ¬† ¬† ¬† if (dayOfWeek === 5 || dayOfWeek === 4) { // 5=Viernes, 6=S√°bado
        // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† timesToIterate.push('19:30');
        // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† timesToIterate.sort(); // Opcional: para mantener el orden de los horarios
        // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.log('Agregado el horario 19:30 para Viernes/S√°bado.');
        // ¬† ¬† ¬† ¬† ¬† ¬† }
        //             const currentExclusions = professionalSpecificExclusions[professional]?.[dayOfWeek] || [];
        //             console.log(`Exclusiones espec√≠ficas fijas para ${professional} el d√≠a ${dayOfWeek}:`, currentExclusions);


        //             console.log('Iterando sobre los siguientes horarios (despu√©s del filtro de inicio):', timesToIterate);

        //             // Iterar sobre la lista de horarios determinada (base o filtrada por inicio de jornada)
        //             timesToIterate.forEach(optionValue => {
        //                 const optionText = `${optionValue} hs`;

        //                 // Convertir la hora del turno a un objeto Date para compararla con la hora actual
        //                 // Usar una fecha y hora completa para una comparaci√≥n correcta
        //                 const optionDateTime = new Date(`${formattedDate}T${optionValue}:00`);

        //                 // Comprobar si la opci√≥n es para el pasado y estamos en el mismo d√≠a
        //                 const isPast = formattedDate === currentDateFormatted &&
        //                     (now.getHours() > optionDateTime.getHours() ||
        //                      (now.getHours() === optionDateTime.getHours() && now.getMinutes() >= optionDateTime.getMinutes())); // Usar >= para excluir el minuto actual

        //                 // Comprobar si es una hora excluida espec√≠ficamente para este profesional y d√≠a
        //                 const isSpecificallyExcluded = currentExclusions.includes(optionValue);

        //                 // Comprobar si ya est√° reservada
        //                 const isReserved = reservedTimesForDateAndProfessional.includes(optionValue);

        //                 console.log(`Evaluando ${optionValue}: isPast=${isPast}, isSpecificallyExcluded=${isSpecificallyExcluded}, isReserved=${isReserved}`);


        //                 // Si no es en el pasado, no est√° espec√≠ficamente excluida y no est√° reservada, agregar la opci√≥n
        //                 if (!isPast && !isSpecificallyExcluded && !isReserved) {
        //                     console.log(`>>> ${optionValue} agregado como opci√≥n disponible.`);
        //                     const option = document.createElement('option');
        //                     option.value = optionValue;
        //                     option.textContent = optionText;
        //                     timeSelect.appendChild(option);
        //                     hasAvailableTimes = true; // Hay horarios disponibles
        //                 } else {
        //                      if(isPast) console.log(`--- ${optionValue} no agregado: est√° en el pasado.`);
        //                      if(isSpecificallyExcluded) console.log(`--- ${optionValue} no agregado: est√° espec√≠ficamente excluido (fijo).`);
        //                      if(isReserved) console.log(`--- ${optionValue} no agregado: ya est√° reservado.`);
        //                 }
        //             });

        //             // Si no se agregaron opciones despu√©s de iterar, a√±ade el mensaje de no disponibles
        //             if (!hasAvailableTimes) {
        //                  timeSelect.innerHTML = ''; // Asegurarse de que est√© vac√≠o si no hay nada disponible
        //                  const defaultOption = document.createElement('option');
        //                  defaultOption.value = "";
        //                  defaultOption.textContent = "No hay turnos disponibles";
        //                  defaultOption.disabled = true; // Hacerla no seleccionable
        //                  timeSelect.appendChild(defaultOption);
        //                  noAvailableMessage.style.display = 'block';
        //                  console.log('No se encontraron horarios disponibles. Mostrando mensaje.');
        //             } else {
        //                  noAvailableMessage.style.display = 'none';
        //                  console.log('Se encontraron horarios disponibles.');
        //             }


        //             console.log('--- populateTimeOptions FINALIZADA ---');
        //         }
        // === END MODIFIED populateTimeOptions Function ===

        // Funci√≥n para mostrar el modal de confirmaci√≥n
        function showConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'block';
        }

        // Funci√≥n para cerrar el modal de confirmaci√≥n
        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }
        function initDatePicker() {
            // Obtener la fecha de hoy
            const today = new Date();

            // Establecer el 30 de abril como la fecha m√°xima permitida (abril es mes 3 porque empieza en 0)


            flatpickr("#calendar", {
                dateFormat: "d/m/Y",
                locale: "es",
                minDate: today, // Desde hoy

                onDayCreate: function (dObj, dStr, fp, dayElem) {
                    const dayOfWeek = dayElem.dateObj.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 1) {
                        dayElem.classList.add('disabled');
                        dayElem.title = "Este d√≠a no est√° disponible";
                    }
                },
                // disable: [
                //     function(date) {
                //         // Deshabilita domingos (0) y lunes (1)
                //         return (date.getDay() === 0 || date.getDay() === 1);
                //     }
                // ]
                disable: [
                    function (date) {
                        const dayOfWeek = date.getDay();

                        // Formatear la fecha para comparaci√≥n DD/MM/YYYY
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        const dateString = `${day}/${month}/${year}`;

                        // Excepci√≥n para los lunes 22/12/2025 y 29/12/2025
                        const isSpecialMonday = (dateString === '22/12/2025' || dateString === '29/12/2025');

                        // Deshabilita domingos (0) Y lunes (1) A MENOS QUE sea un lunes de excepci√≥n
                        if (dayOfWeek === 0) {
                            return true; // Deshabilita todos los domingos
                        }

                        if (dayOfWeek === 1) {
                            return !isSpecialMonday; // Deshabilita lunes, PERO habilita si es la fecha especial
                        }

                        return false; // Habilita el resto de d√≠as (Martes a S√°bado)
                    }
                ]
            });
        }


        //         function initDatePicker() {
        //     // Obtener la fecha de hoy
        //     const today = new Date();

        //     // Calcular la fecha de finalizaci√≥n del bloqueo (7 d√≠as a partir de hoy)
        //     const blockEndDate = new Date(today);
        //     blockEndDate.setDate(today.getDate() + 7);

        //     flatpickr("#calendar", {
        //         dateFormat: "d/m/Y",
        //         locale: "es",
        //         minDate: "today", // Restringe las fechas a partir de hoy
        //         maxDate: blockEndDate, // Bloquear fechas despu√©s de una semana
        //         onDayCreate: function(dObj, dStr, fp, dayElem) {
        //             const dayOfWeek = dayElem.dateObj.getDay();
        //             if (dayOfWeek === 0 || dayOfWeek === 1) {
        //                 dayElem.classList.add('disabled');
        //                 dayElem.title = "Este d√≠a no est√° disponible";
        //             }
        //         },
        //         disable: [
        //             function(date) {
        //                 return (date.getDay() === 0 || date.getDay() === 1);
        //             }
        //         ]
        //     });
        // }

        //         function initDatePicker() {
        //     flatpickr("#calendar", {
        //         dateFormat: "d/m/Y",
        //         locale: "es",
        //         minDate: "today", // Restringe las fechas a partir de hoy
        //         onDayCreate: function(dObj, dStr, fp, dayElem) {
        //             const dayOfWeek = dayElem.dateObj.getDay();
        //             if (dayOfWeek === 0 || dayOfWeek === 1) {
        //                 dayElem.classList.add('disabled');
        //                 dayElem.title = "Este d√≠a no est√° disponible";
        //             }
        //         },
        //         disable: [
        //             function(date) {
        //                 return (date.getDay() === 0 || date.getDay() === 1);
        //             }
        //         ]
        //     });
        // }


        // Obtener elementos del DOM
        const openModalButton = document.getElementById('open-modal-button');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');

        // Evento para mostrar el modal de autenticaci√≥n
        openModalButton.addEventListener('click', function () {
            authModal.style.display = 'block';
        });

        // Evento para cerrar el modal de autenticaci√≥n
        function closeAuthModal() {
            authModal.style.display = 'none';
        }

        authForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (email === 'admin@example.com' && password === 'admin123') {
                alert('Acceso concedido');
                authModal.style.display = 'none';
                document.querySelector('.reservations').style.display = 'block';
                getRecords();
            } else {
                alert('Email o contrase√±a incorrectos');
            }
        });

        // Funci√≥n para convertir una fecha a un objeto Date para la comparaci√≥n
        // function parseDate(dateString) {
        //     const [day, month, year] = dateString.split('/').map(Number);
        //     return new Date(year, month - 1, day);
        // }

        // Funci√≥n para convertir la fecha (DD/MM/YYYY) a un objeto Date para ordenar
        function parseDate(dateString) {
            // Si no es una cadena o es nula/indefinida, retorna 0 (valor seguro)
            if (!dateString || typeof dateString !== 'string') return 0;

            const parts = dateString.split('/');

            // Si la fecha no tiene 3 partes (d√≠a, mes, a√±o), retorna 0
            if (parts.length !== 3) return 0;

            // Devolver el objeto Date. Usamos parts[1]-1 para el mes (JavaScript es base 0)
            const date = new Date(parts[2], parts[1] - 1, parts[0]);

            // Si la fecha es inv√°lida (ej. 31/02/2025), retorna 0
            if (isNaN(date)) return 0;

            return date;
        }

        document.getElementById('send-whatsapp').addEventListener('click', async () => {
            const reservationsCol = collection(db, 'Reserva');
            const querySnapshot = await getDocs(reservationsCol);
            const reservations = [];

            // Obtener la fecha de ma√±ana
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            // Formatear la fecha de ma√±ana a "dd/mm/yyyy"
            const dd = String(tomorrow.getDate()).padStart(2, '0');
            const mm = String(tomorrow.getMonth() + 1).padStart(2, '0'); // Enero es 0
            const yyyy = tomorrow.getFullYear();
            const formattedTomorrow = `${dd}/${mm}/${yyyy}`;

            querySnapshot.forEach((doc) => {
                const data = doc.data();

                // Filtrar por la fecha de ma√±ana
                if (data.fecha === formattedTomorrow) {
                    reservations.push(data);
                }
            });

            console.log(`Reservas de ma√±ana encontradas: ${reservations.length}`);

            if (reservations.length === 0) {
                alert('No hay turnos de ma√±ana para enviar.');
                return;
            }

            // Enviar mensajes con setTimeout para asegurar la apertura correcta de cada mensaje
            reservations.forEach((reservation, index) => {
                const phoneNumber = `549${reservation.contacto}`;
                // const message = `¬°Hola ${reservation.nombre}! Te recordamos tu turno de ma√±ana a las ${reservation.hora} con ${reservation.profesional} para ${reservation.servicio}. ¬°Te esperamos!`;
                const message = `¬°Hola ${reservation.nombre}! Te recordamos tu turno de ma√±ana a las ${reservation.hora} con ${reservation.profesional} para ${reservation.servicio}. ¬°Te esperamos!

        **Recordatorio importante:** En caso de no poder asistir, solicitamos avisar con un m√≠nimo de **2 horas de anticipaci√≥n**. De lo contrario, se deber√° abonar el valor total del servicio.`;
                console.log(`Enviando mensaje a: ${phoneNumber}`);
                console.log(`Mensaje: ${message}`);

                // URL de WhatsApp con mensaje prellenado y par√°metro aleatorio
                const randomParam = Math.random().toString(36).substring(7); // Generar una cadena aleatoria
                const whatsappUrl = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}&random=${randomParam}`;

                // Abrir el enlace de WhatsApp con un peque√±o retraso para cada mensaje
                setTimeout(() => {
                    window.open(whatsappUrl, `_blank`);
                }, index * 1500); // Incrementar el tiempo de espera para cada mensaje (1.5 segundos por mensaje)
            });
        });









        // --- LOGICA DEL BOT DE CONSULTA ---
        const botBtn = document.getElementById('bot-btn');
        const botModal = document.getElementById('bot-modal');
        const closeBotBtn = document.getElementById('close-bot-modal');
        const botConsultBtn = document.getElementById('bot-consult-btn');
        const botPhoneInput = document.getElementById('bot-phone-input');
        const botResults = document.getElementById('bot-results');

        if (botBtn) {
            botBtn.addEventListener('click', () => {
                botModal.style.display = 'block';
                botPhoneInput.focus();
            });
        }

        if (closeBotBtn) {
            closeBotBtn.addEventListener('click', () => {
                botModal.style.display = 'none';
            });
        }

        // Cerrar modal al hacer clic fuera (si se hace clic en el fondo oscuro)
        window.addEventListener('click', (event) => {
            // Verificamos si el clic fue en el modal contenedor (fondo oscuro)
            if (event.target == botModal) {
                botModal.style.display = "none";
            }
        });

        if (botConsultBtn) {
            botConsultBtn.addEventListener('click', async () => {
                const phone = botPhoneInput.value.trim();

                if (!phone) {
                    alert("Por favor, ingresa tu n√∫mero de tel√©fono.");
                    return;
                }

                botResults.innerHTML = '<p style="text-align:center; color: #ccc;">Buscando...</p>';

                try {
                    // Consulta simple por coincidencia exacta del campo 'contacto'
                    const q = query(collection(db, "Reserva"), where("contacto", "==", phone));
                    const querySnapshot = await getDocs(q);

                    const appointments = [];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();

                        // Parsear fecha DD/MM/YYYY para comparar
                        if (data.fecha) {
                            const partes = data.fecha.split('/');
                            if (partes.length === 3) {
                                const appDate = new Date(partes[2], partes[1] - 1, partes[0]);
                                // Si es hoy o futuro
                                if (appDate >= today) {
                                    appointments.push(data);
                                }
                            }
                        }
                    });

                    // Ordenar por fecha y hora
                    appointments.sort((a, b) => {
                        const [d1, m1, y1] = a.fecha.split('/');
                        const date1 = new Date(y1, m1 - 1, d1);
                        const [d2, m2, y2] = b.fecha.split('/');
                        const date2 = new Date(y2, m2 - 1, d2);

                        if (date1.getTime() !== date2.getTime()) {
                            return date1 - date2;
                        }
                        // Si es la misma fecha, ordenar por hora
                        return a.hora.localeCompare(b.hora);
                    });

                    if (appointments.length === 0) {
                        botResults.innerHTML = '<p style="text-align:center; color: #ff9999;">No se encontraron turnos futuros para este n√∫mero.</p>';
                    } else {
                        botResults.innerHTML = '';
                        appointments.forEach(app => {
                            const item = document.createElement('div');
                            item.className = 'bot-result-item';
                            item.innerHTML = `
                                <div style="font-weight:bold; color: #c8a97e; font-size: 1.1em;">${app.fecha} - ${app.hora}hs</div>
                                <div style="color: white;">Profesional: <span style="color: #ccc;">${app.profesional}</span></div>
                                <div style="color: white;">Servicio: <span style="color: #ccc;">${app.servicio}</span></div>
                            `;
                            botResults.appendChild(item);
                        });
                    }

                } catch (error) {
                    console.error("Error consultando bot:", error);
                    botResults.innerHTML = '<p style="color:red; text-align:center;">Error al consultar. Intenta nuevamente.</p>';
                }
            });
        }


        // Inicializar al cargar la p√°gina
        window.onload = function () {
            initDatePicker();
            getRecords(); // Cargar las reservas al iniciar

            // Agregar evento al bot√≥n de reserva
            document.getElementById('book-button').addEventListener('click', bookAppointment);

            // Actualizar opciones de hora cuando se seleccione la fecha o el profesional
            document.getElementById('calendar').addEventListener('change', populateTimeOptions);
            document.getElementById('professional').addEventListener('change', populateTimeOptions);
        };


    </script>
</head>

<body>
    <header>
        <div class="brand-image">
            <img src="images/nile_header.jpg" alt="Marca">
        </div>
    </header>

    <div class="container">
        <img src="images/newequipo.jpg" alt="" class="imagen-fondo">
        <div class="booking-form">
            <label for="name">NOMBRE COMPLETO:</label>
            <input type="text" id="name" required>

            <label for="phone">Tel√©fono:</label>
            <input type="tel" id="phone" name="phone" required placeholder="Ejemplo: 1199998888">

            <div class="form-row">
                <div class="form-group">
                    <label for="professional">PROFESIONAL:</label>
                    <select id="professional" required>
                        <option value="Matias">Matias</option>
                        <option value="Pablo">Pablo</option>
                        <option value="Lautaro">Lautaro</option>
                        <option value="Nicolas">Nicolas</option>

                    </select>
                </div>

                <div class="form-group">
                    <label for="calendar">FECHA:</label>
                    <input type="text" id="calendar" required>
                </div>
            </div>

            <label for="time">HORA:</label>
            <select id="time" required></select>
            <p id="no-available-message" style="display: none; color: red;">No hay turnos disponibles para la fecha
                seleccionada.</p>


            <!-- Nuevo campo para seleccionar servicio -->
            <label for="service">SERVICIOS:</label>
            <select id="service" required>
                <option value="Corte">Corte $14.000</option>
                <option value="Corte + Barba">Corte + Barba $16.000</option>
                <option value="Barba">Barba $12.000</option>
                <!-- Agrega m√°s opciones seg√∫n sea necesario -->
            </select>

            <button id="book-button">RESERVAR</button>
        </div>

        <div class="reservations" style="display: none;">
            <h2>TURNOS RESERVADOS</h2>
            <ul id="appointment-list"></ul>
            <!-- <div class="reservations-grid" id="appointment-list"></div> -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="send-whatsapp" class="btn">Enviar WhatsApp</button>
            </div>


        </div>
    </div>

    <!-- Mensaje de confirmaci√≥n
    <div id="confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeConfirmationModal()">&times;</span>
            <p>¬°Tu turno ha sido reservado con √©xito!</p>
            
        </div>
    </div> -->

    <!-- Modal de autenticaci√≥n del administrador -->
    <div id="auth-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAuthModal()">&times;</span>
            <h2>Acceso Personal</h2>
            <form id="auth-form">
                <label for="admin-email">Email:</label>
                <input type="email" id="admin-email" required>
                <label for="admin-password">Contrase√±a:</label>
                <input type="password" id="admin-password" required>
                <button type="submit">Iniciar sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- Bot√≥n movido al footer -->

    <div id="custom-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" id="close-modal-button">&times;</span>
            <button id="confirm-button">Confirmar</button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="contact-info">
                <p><strong>Direcci√≥n: </strong>Av. De Mayo 702 - Ramos Mejia</p>
                <p><strong>Horarios:</strong> Martes a S√°bado: 10:30 - 20:00</p>
            </div>
            <div class="social-media">
                <a href="https://www.instagram.com/nile.urbanlounge" target="_blank" title="S√≠guenos en Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://www.tiktok.com/@nile.urban" target="_blank" title="S√≠guenos en TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>
                <button id="open-modal-button"
                    style="background-color: #333; color: #fff; border: 1px solid #555; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em; margin-left: 10px;">Acceso
                    Personal</button>
            </div>
        </div>
    </footer>

    <!-- Bot√≥n Flotante del Bot -->
    <button id="bot-btn" class="bot-float-btn" title="Consultar mis turnos">
        <i class="fas fa-calendar-check"></i>
    </button>

    <!-- Modal del Bot -->
    <div id="bot-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-bot-modal">&times;</span>
            <h2 style="color: #c8a97e; border-bottom: 2px solid #c8a97e; padding-bottom: 10px; margin-bottom: 10px;">
                Consulta tus Turnos</h2>
            <p style="color: #ccc; margin-bottom: 5px;">Ingresa tu n√∫mero de tel√©fono para ver tus pr√≥ximas citas.</p>
            <input type="tel" id="bot-phone-input" placeholder="Ej: 1199998888"
                style="background: #333; color: white; border: 1px solid #555; padding: 10px; width: 90%; border-radius: 5px; text-align: center;">
            <button id="bot-consult-btn"
                style="width: 100%; margin-top: 15px; background-color: #c8a97e; color: black; border: none; font-weight: bold;">Consultar</button>
            <div id="bot-results"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.min.js"></script>
    <script>
        // Script para actualizar precios seg√∫n la fecha seleccionada
        function actualizarPreciosPorFecha(fechaStr) {
            const serviceSelect = document.getElementById('service');
            if (!serviceSelect) return;

            // Si no hay fecha, usar precios base (martes/mi√©rcoles)
            let corte = 18000;
            let corteBarba = 20000;
            if (fechaStr) {
                // Detectar formato: DD/MM/YYYY
                let partes = fechaStr.split('/');
                let dateObj;
                if (partes.length === 3) {
                    // Asume formato DD/MM/YYYY
                    dateObj = new Date(partes[2], partes[1] - 1, partes[0]);
                } else {
                    // Si el formato es YYYY-MM-DD (por flatpickr u otro)
                    partes = fechaStr.split('-');
                    if (partes.length === 3) {
                        dateObj = new Date(partes[0], partes[1] - 1, partes[2]);
                    }
                }
                if (dateObj && !isNaN(dateObj)) {
                    const dia = dateObj.getDay(); // 0=Dom, 1=Lun, 2=Mar, 3=Mi√©, 4=Jue, 5=Vie, 6=S√°b
                    if (dia === 2 || dia === 3) { // Martes o Mi√©rcoles
                        corte = 18000;
                        corteBarba = 20000;
                    } else if (dia >= 4 && dia <= 6) { // Jueves, Viernes, S√°bado
                        corte = 20000;
                        corteBarba = 22000;
                    }
                }
            }
            serviceSelect.innerHTML = `
            <option value="Corte">Corte $${corte.toLocaleString('es-AR')}</option>
            <option value="Corte + Barba">Corte + Barba $${corteBarba.toLocaleString('es-AR')}</option>
            <option value="Barba">Barba $14.000</option>
        `;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const calendar = document.getElementById('calendar');
            if (calendar) {
                // Inicializa precios seg√∫n la fecha actual (si hay valor)
                actualizarPreciosPorFecha(calendar.value);
                calendar.addEventListener('change', function () {
                    actualizarPreciosPorFecha(this.value);
                });
            } else {
                // Si no hay calendario, usa el d√≠a de hoy
                actualizarPreciosPorFecha();
            }
        });
    </script>
</body>

</html>